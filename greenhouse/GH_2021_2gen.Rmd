---
title: "GH_2gen_2021"
author: "Mohammad Inam Jameel"
date: "4/12/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Setting up the environment
```{r, include = FALSE}
#libraries
library(dplyr)
library(ggplot2)
library(nlme)
library(lme4)
packageVersion("lme4")
library(tidyr)
library(broom)
library(car)
library(MASS)
library(emmeans)
library(visreg)
library(fitdistrplus)
library(gamlss)
library(rjags)
library(gamlss)
library(effects)

 
setwd("~/Desktop/Anderson_data/herbivory/data/greenhouse/")


#read in data 
gh2 <- read.csv("GHSummary2021.csv")
#gh2 <- drop_na(gh2,LAR)
gh2 $S_elev<-scale(gh2$elevation,center=TRUE, scale=TRUE)
gh2$elev<-gh2$elevation/1000
gh2 $S_init_size<-scale(gh2$ini_size,center=TRUE, scale=TRUE)
gh2$SLA100<-gh2$SLA*100


##convert LAR from most recent exposure (LAR 13) to proportion
  gh2$LAR_prop<- gh2$LAR13/100
  hist(gh2$LAR13)
  
#Check that the conversion worked
  hist(gh2$LAR_prop)
  #head(gh2)  

##Some of your variables are being read as characters not factors. Let's fix that
gh2$genotype<-as.factor(gh2$genotype)
gh2$treatment<-as.factor(gh2$treatment)
gh2$block<-as.factor(gh2$block)
gh2$mat_treat<-as.factor(gh2$mat_treat)
gh2$mat_exp_ID <-as.factor(gh2$mat_exp_ID) #need to include this as random effect since multiple reps per mat line
gh2$trichomes <- gh2$avg_trichomes +0.001 #added to do gamma glmer
```
## Relative contributions {.tabset}

### SLA individual 
```{r}
RC_SLA<- lmer(SLA100 ~ treatment+elev+mat_treat+S_init_size +(1|block),control = lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e7)), data = gh2)
Anova(RC_SLA)
plot (RC_SLA)

visreg(RC_SLA, overlay = TRUE, "elev", by="treatment", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="Specific leaf area", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  

visreg(RC_SLA, "elev", by="mat_treat",type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="Specific leaf area", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
      fill=list(col=grey(c(0.7,0.9))),
      line=list(col=grey(c(0,0.5))),
       #points=list(cex=1.5,col=grey(c(0.2,0.8)))
      )  


```

### SLA family level

#am not running this code since i only needed to do it once
```{r eval = FALSE, echo = FALSE}
#to make the emmeans file
modB<- lmer(SLA100 ~ genotype+mat_treat+treatment+S_init_size +(1|block),control = lmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e7)), data = gh2)
fam_avg_linear<-emmeans(modB, ~genotype+mat_treat+treatment)
fam_means_linear<-as.data.frame(fam_avg_linear)
write.csv(fam_means_linear,file="LSmeans_SLA_2.csv")

#read in emmeans
LSmeans_SLA <- read.csv("LSmeans_SLA_2.csv", stringsAsFactors=TRUE)

#now we have lsmeans, but need to add corresponding elevation
elev <- gh2[c("genotype","elevation")] #make dataframe of genotypes and corresponding elev
elev <- unique(elev) #calls unique rows 
LSmeans_SLA <- merge(LSmeans_SLA,elev,by="genotype") #merge the dataframes

LSmeans_SLA$elev<-LSmeans_SLA$elevation/1000
#LSmeans_SLA$emmean<-LSmeans_SLA$emmean*100

write.csv(LSmeans_SLA,file="LSmeans_SLA_2.csv")
#read in emmeans
LSmeans_SLA <- read.csv("LSmeans_SLA_2.csv", stringsAsFactors=TRUE)
```

```{r}
#RC_SLA_means<- lmer(emmean ~ elevation+treatment+mat_treat +(1|genotype), data = LSmeans_SLA) #issues with rescaling??
#Anova(RC_SLA_means)

RC_SLA_means<- lm(emmean ~ elevation+treatment+mat_treat, data = LSmeans_SLA)
Anova(modB)
plot(modB)

##use this

visreg(RC_SLA_means, overlay = TRUE, "elevation", by="treatment", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="specific leaf area", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  

visreg(RC_SLA_means, overlay = FALSE, "elevation", by="mat_treat", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="specific leaf area", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       #fill=list(col=grey(c(0.7,0.9))),
       #line=list(col=grey(c(0,0.5))),
       #points=list(cex=1.5,col=grey(c(0.2,0.8)))
       ) 

```

### Trichomes individual
```{r}
RC_Tri<- glmer(trichomes ~ mat_treat*elev+treatment+S_init_size +(1|block),family = Gamma(link=log), data = gh2) 
#had errors but this seems to work when i specify link=log
#singular fit

Anova(RC_Tri) # elev is sig, sig interaction btw mat_treat and elev
plot (RC_Tri)

visreg(RC_Tri, "elev", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="Avg Trichomes", partial=FALSE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  

visreg(RC_Tri, "elev", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="Avg Trichomes", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  



visreg(RC_Tri, "elev",  by="mat_treat", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="Avg Trichomes", partial=FALSE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  

visreg(RC_Tri, "elev",  by="mat_treat", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="Avg Trichomes", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  


```

### trichomes family level

#am not running this code since i only needed to do it once
```{r eval = FALSE, echo = FALSE}
#to make the emmeans file
modC<- glmer(trichomes ~ mat_treat*genotype+treatment +(1|block),family = Gamma(link=log), data = gh2) 
Anova(modC)
fam_avg_linear<-emmeans(modC, ~genotype+mat_treat*treatment)
fam_means_linear<-as.data.frame(fam_avg_linear)
write.csv(fam_means_linear,file="LSmeans_tri.csv")

#read in emmeans
LSmeans_tri <- read.csv("LSmeans_tri.csv", stringsAsFactors=TRUE)

#now we have lsmeans, but need to add corresponding elevation
elev <- gh2[c("genotype","elevation")] #make dataframe of genotypes and corresponding elev
elev <- unique(elev) #calls unique rows 
LSmeans_tri <- merge(LSmeans_tri,elev,by="genotype") #merge the dataframes

LSmeans_tri$elev<-LSmeans_tri$elevation/1000

write.csv(LSmeans_tri,file="LSmeans_tri.csv")
#read in emmeans
LSmeans_tri <- read.csv("LSmeans_tri.csv", stringsAsFactors=TRUE)
RC_tri_means<- lm(emmeans ~ mat_treat*elev+treatment, data = LSmeans_tri) 
```

```{r}

RC_tri_means<- glmer(emmeans ~ mat_treat*elev+treatment, family = Gamma(link=log), data = LSmeans_tri) 
Anova(modC) #issues with rescaling??
#Anova(RC_SLA_means)



##use this

visreg(RC_SLA_means, overlay = TRUE, "elevation", by="treatment", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="specific leaf area", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       fill=list(col=grey(c(0.7,0.9))),
       line=list(col=grey(c(0,0.5))),
       points=list(cex=1.5,col=grey(c(0.2,0.8))))  

visreg(RC_SLA_means, overlay = FALSE, "elevation", by="mat_treat", type="conditional", scale = "response", 
       xlab="Elevation (m)", ylab="specific leaf area", partial=TRUE, cex.lab = 1.5,cex.axis = 1.5,
       #fill=list(col=grey(c(0.7,0.9))),
       #line=list(col=grey(c(0,0.5))),
       #points=list(cex=1.5,col=grey(c(0.2,0.8)))
       ) 

## Selection on Plasticity {.tabset}



